[TOC]

# Android 动态分区详解(二)  动态分区相关模块和工具介绍

## 1. 导读

上一节提到 Android 动态分区的核心是位于 super 分区头部 4K 偏移处开始的 metadata 数据，本篇简单介绍动态分区相关的代码模块和相关工具。

> 本文主要基于 Android Q 代码 QTG1.201104.001, 基本上也适合后续的 Android R/S 版本

## 2. Android 动态分区相关模块

动态分区主要的相关模块包括 liblp, libdm, libsparse 等

### 2.1 liblp

liblp 模块代码位于 "`system/core/fs_mgr/liblp`" 目录中。

从名字来看，liblp 应该是 logic partition library 的意思， 是动态分区最核心的模块。其主要功能是负责动态分区数据在内存和物理设备上的增删改查操作。

动态分区核心数据结构的定义位于以下两个文件中:

```bash
system/core/fs_mgr/liblp/include/liblp/metadata_format.h
system/core/fs_mgr/liblp/include/liblp/liblp.h
```

我已经将这两个文件中主要的数据结构用一张不太正规的框图来显示，阅读代码时配合这张框图会比较方便:

![](images-20220402-Android 动态分区详解(二) 动态分区相关工具介绍/DynamicPartitionMetadata-DataStructure.png)

**图 1.** 动态分区核心数据结构 LpMetadata

### 2.2 libdm

libdm 模块代码位于 `system/core/fs_mgr/libdm` 目录中。

liblp 中的函数将动态分区数据从物理设备上读取到内存中，解析并建立 LpMetadata 数据结构，随后从 LpMetadata 数据中提取 super 分区内部子分区映射到虚拟设备的映射表，例如前一篇《[Android 动态分区详解(一) 5 张图让你搞懂动态分区原理](https://blog.csdn.net/guyongqiangx/article/details/123899602)》示例中提到的"system_a" 和 "vendor_a" 独自的映射表:

```c++
/* system_a */
{
    0, 2104888,
    "/dev/block/by-id/super",
    2048
},

/* vendor_a */
{
    0, 205064,
    "/dev/block/by-id/super",
    2107392
}
```

换个表述方式就是：

- 将 "`/dev/block/by-id/super`" 分区的 2048 开始的 2104888 个 sector 映射到 "`/dev/block/mapper/system_a`" 设备的 0 位置。
- 将 "`/dev/block/by-id/super`" 分区的 2107392 开始的 205064 个 sector 映射到 `/dev/block/mapper/vendor_a` 设备的 0 位置。

libdm 的作用就是管理这些映射表，并将其提交给 linux 的 device mapper 驱动映射成虚拟设备，或取消对虚拟设备的映射，以及查询虚拟设备的映射状态等。

### 2.3 libfs_mgr

`libfs_mgr` 模块代码位于 `system/core/fs_mgr` 目录中。

`libfs_mgr` 是整个 Android 分区和文件系统管理的模块，跟动态分区相关的只有一个文件:

```
system/core/fs_mgr/fs_mgr_dm_linear.cpp
```

这个文件提供的函数调用 liblp 读取 metadata，并将其提交给 libdm 用于映射虚拟分区。

### 2.4 libsparse

libsparse 模块代码位于 `system/core/libsparse` 目录中。

libsparse 主要用于对 sparse 文件的处理，只有当需要处理 sparse image 格式的 image 时才会需要用到这个库的函数。

关于 sparse image，我后面会专门写一篇博客介绍。

libsparse 模块下有两个很重要的工具:

- simg2img, img2simg, 这两个工具在编译时会生成到 `out/host/linux-x86/bin` 目录下，用于将镜像文件在 sparse image 和 raw image 间转换。
- simg_dump.py, 专门用来查看 sparse image 的信息

## 3. Android 动态分区相关工具

